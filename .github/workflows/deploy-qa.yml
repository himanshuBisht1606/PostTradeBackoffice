name: Deploy â€” QA

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    types:
      - closed
  workflow_dispatch:

env:
  DOTNET_VERSION: "8.0.x"

permissions:
  contents: read
  packages: write

jobs:
  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || github.event.pull_request.merged == true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore
        run: dotnet restore backend/PostTradeBackoffice.sln

      - name: Build
        run: dotnet build backend/PostTradeBackoffice.sln --no-restore --configuration Release

      - name: Run unit tests
        run: >
          dotnet test
          backend/tests/PostTrade.Tests/PostTrade.Tests.csproj
          --no-build --no-restore
          --configuration Release
          --nologo
          --logger "console;verbosity=minimal"
          --logger "trx;LogFileName=unit-test-results.trx"

      - name: Upload unit test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: "**/*.trx"

  integration-test:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name != 'pull_request' || github.event.pull_request.merged == true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore
        run: dotnet restore backend/PostTradeBackoffice.sln

      - name: Build
        run: dotnet build backend/PostTradeBackoffice.sln --no-restore --configuration Release

      - name: Run integration tests
        env:
          TESTCONTAINERS_RYUK_DISABLED: "true"
        run: >
          dotnet test
          backend/tests/PostTrade.IntegrationTests/PostTrade.IntegrationTests.csproj
          --no-build --no-restore
          --configuration Release
          --nologo
          --logger "console;verbosity=normal"
          --logger "trx;LogFileName=integration-test-results.trx"

      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: "**/*.trx"

  build-and-deploy:
    name: Build, Push & Deploy to QA VM
    runs-on: ubuntu-latest
    needs: integration-test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image name and short SHA
        id: vars
        run: |
          echo "short=${GITHUB_SHA::8}" >> "$GITHUB_OUTPUT"
          echo "image=ghcr.io/$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')/posttrade-api" >> "$GITHUB_OUTPUT"

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: backend
          file: backend/Dockerfile
          push: true
          tags: |
            ${{ steps.vars.outputs.image }}:qa-${{ steps.vars.outputs.short }}
            ${{ steps.vars.outputs.image }}:qa-latest

      - name: Copy docker-compose file to QA VM
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.QA_VM_HOST }}
          username: opc
          key: ${{ secrets.VM_SSH_KEY }}
          source: docker-compose.qa.yml
          target: ~/posttrade/

      - name: Deploy to QA VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.QA_VM_HOST }}
          username: opc
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            cd ~/posttrade

            # Log in to GitHub Container Registry
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io \
              --username "${{ github.actor }}" \
              --password-stdin

            # Pull latest image
            docker pull ${{ steps.vars.outputs.image }}:qa-latest

            # Write env file (never stored in repo)
            cat > .env <<EOF
            QA_DB_CONNECTION=${{ secrets.QA_DB_CONNECTION }}
            JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
            EOF

            # Start / recreate containers
            docker compose -f docker-compose.qa.yml up -d --pull always --force-recreate

            # Clean up old images
            docker image prune -f

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.QA_VM_HOST }}
          username: opc
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            sleep 15
            curl --fail --silent http://localhost/health \
              && echo "Health check passed" \
              || (echo "Health check failed" && exit 1)
