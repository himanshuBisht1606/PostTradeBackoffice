name: posttrade-signoz

# SigNoz self-hosted observability stack (single-binary architecture).
# Run ONCE on the VM — stays up permanently, independent of app deployments.
#
# Start:   docker compose -f docker-compose.signoz.yml up -d
# UI:      http://<VM-IP>:8080
# Stop:    docker compose -f docker-compose.signoz.yml down
#
# The PostTrade API sends traces, metrics, and logs to signoz-otel-collector:4317 (gRPC).
#
# Image versions (pinned from SigNoz v0.69 release):
#   signoz/signoz:v0.112.0                 – unified UI + query service
#   signoz/signoz-otel-collector:0.111.24  – OTel Collector (follows upstream OTel versioning)
#   signoz/signoz-schema-migrator:latest   – one-time DB init
#   clickhouse/clickhouse-server:24.1.2-alpine – storage backend
#   signoz/zookeeper:3.7.1               – ClickHouse coordination (SigNoz-packaged image)

x-clickhouse-defaults: &clickhouse-defaults
  image: clickhouse/clickhouse-server:24.1.2-alpine
  restart: on-failure
  tty: true
  ulimits:
    nproc: 65535
    nofile:
      soft: 262144
      hard: 262144
  logging:
    options:
      max-size: "50m"
      max-file: "3"

volumes:
  signoz-clickhouse-data:
  signoz-clickhouse-logs:
  signoz-sqlite-data:
  signoz-zookeeper-data:
  signoz-zookeeper-logs:
  signoz-zookeeper-datalog:

networks:
  posttrade-observability:
    name: posttrade-observability
    driver: bridge

services:

  # ── ZooKeeper — ClickHouse coordination ──────────────────────────────────────
  zookeeper-1:
    image: signoz/zookeeper:3.7.1
    container_name: signoz-zookeeper
    restart: on-failure
    hostname: zookeeper-1
    user: root
    environment:
      ZOO_SERVER_ID: 1
      ZOO_SERVERS: "server.1=zookeeper-1:2888:3888;2181"
      JVMFLAGS: "-Xms256m -Xmx256m"
      ZOO_AUTOPURGE_PURGE_INTERVAL: 1
    volumes:
      - signoz-zookeeper-data:/data
      - signoz-zookeeper-logs:/logs
      - signoz-zookeeper-datalog:/datalog
    logging:
      options:
        max-size: "50m"
        max-file: "3"
    networks: [posttrade-observability]

  # ── ClickHouse — telemetry storage backend ───────────────────────────────────
  clickhouse:
    <<: *clickhouse-defaults
    container_name: signoz-clickhouse
    depends_on:
      - zookeeper-1
    hostname: clickhouse
    ports:
      - "9000:9000"
      - "8123:8123"
    volumes:
      - signoz-clickhouse-data:/var/lib/clickhouse
      - signoz-clickhouse-logs:/var/log/clickhouse-server
      - ./observability/clickhouse-config.xml:/etc/clickhouse-server/config.d/signoz-config.xml:ro
      - ./observability/clickhouse-users.xml:/etc/clickhouse-server/users.d/signoz-users.xml:ro
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "localhost:8123/ping"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 60s
    networks: [posttrade-observability]

  # ── Schema migrator — runs once to initialise ClickHouse tables ──────────────
  schema-migrator:
    image: signoz/signoz-schema-migrator:latest
    container_name: signoz-schema-migrator
    command:
      - "sync"
      - "--dsn=tcp://admin:27ff0399-0d3a-4bd8-919d-17c2181e6fb9@clickhouse:9000"
    depends_on:
      clickhouse:
        condition: service_healthy
    restart: "no"
    networks: [posttrade-observability]

  # ── OTel Collector — receives telemetry from PostTrade API ───────────────────
  otel-collector:
    image: signoz/signoz-otel-collector:0.111.24
    container_name: signoz-otel-collector
    command:
      - "--config=/etc/otelcol-config.yaml"
    volumes:
      - ./observability/otel-collector-config.yaml:/etc/otelcol-config.yaml:ro
    ports:
      - "4317:4317"    # OTLP gRPC  ← PostTrade API sends here
      - "4318:4318"    # OTLP HTTP  ← Serilog sink uses this
      - "8888:8888"    # Collector self-metrics (Prometheus scrape)
    depends_on:
      clickhouse:
        condition: service_healthy
      schema-migrator:
        condition: service_completed_successfully
    restart: unless-stopped
    networks: [posttrade-observability]

  # ── SigNoz — unified query service + UI ──────────────────────────────────────
  signoz:
    image: signoz/signoz:v0.112.0
    container_name: signoz
    command:
      - "-config=/root/config/prometheus.yml"
    environment:
      SIGNOZ_LOCAL_DB_PATH: /root/data/signoz.db
      ClickHouseUrl: tcp://admin:27ff0399-0d3a-4bd8-919d-17c2181e6fb9@clickhouse:9000
      STORAGE: clickhouse
      GODEBUG: netdns=go
      TELEMETRY_ENABLED: "false"
      DEPLOYMENT_TYPE: docker-standalone-amd
    volumes:
      - signoz-sqlite-data:/root/data
      - ./observability/prometheus.yml:/root/config/prometheus.yml:ro
    ports:
      - "8080:8080"    # ← SigNoz UI:  http://<VM-IP>:8080
    depends_on:
      clickhouse:
        condition: service_healthy
      schema-migrator:
        condition: service_completed_successfully
    restart: unless-stopped
    networks: [posttrade-observability]
